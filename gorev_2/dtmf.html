<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DTMF Sinyal Sentezi</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }


:root {
  --bg: #f4f6f8;
  --surface: #ffffff;
  --border: #e2e6ea;
  --text: #1a1d23;
  --muted: #8a929e;
  --accent: #2563eb;
  --accent-light: #eff4ff;
  --pressed: #1d4ed8;
  --special: #7c3aed;
  --special-light: #f5f3ff;
  --danger: #dc2626;
  --wave-sum: #2563eb;
  --wave-low: #94b4f5;
  --wave-high: #f59e94;
  --spec-bar: #cbd5e1;
  --spec-peak: #2563eb;
  --radius: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.06);
}

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 32px 20px 48px;
}

h1 {
  font-size: 1.1rem;
  font-weight: 600;
  letter-spacing: -0.01em;
  color: var(--text);
}
h1 span {
  font-weight: 400;
  color: var(--muted);
  margin-left: 8px;
  font-size: 0.85rem;
}

header {
  max-width: 1200px;
  margin: 0 auto 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.badge {
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  background: var(--accent-light);
  color: var(--accent);
  padding: 3px 10px;
  border-radius: 20px;
  border: 1px solid #bfd0f7;
}

/* ── TOP ROW: Tuş Takımı + Zaman/Frekans yan yana ── */
.layout {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.top-row {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 16px;
  align-items: start;
}

/* ── Card ── */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.card-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--muted);
  letter-spacing: 0.07em;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
}

.card-body { padding: 16px 18px; }

/* ── Info strip ── */
.info-strip {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 14px;
}

.info-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
}

.info-item .lbl {
  font-size: 0.65rem;
  font-weight: 600;
  color: var(--muted);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  display: block;
  margin-bottom: 2px;
}

.info-item .val {
  font-family: 'DM Mono', monospace;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text);
}

.info-item .val.active { color: var(--accent); }

/* ── Keypad ── */
.keypad-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}

.key {
  aspect-ratio: 1;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  background: var(--surface);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  font-size: 1.05rem;
  color: var(--text);
  user-select: none;
  transition: background 0.08s, border-color 0.08s, transform 0.08s, box-shadow 0.08s;
  position: relative;
}

.key .sub {
  font-size: 0.45rem;
  font-family: 'DM Mono', monospace;
  color: var(--muted);
  margin-top: 2px;
  font-weight: 400;
}

.key:hover {
  background: var(--accent-light);
  border-color: #bfd0f7;
}

.key.pressed {
  background: var(--accent);
  border-color: var(--pressed);
  color: #fff;
  transform: scale(0.93);
  box-shadow: 0 2px 8px rgba(37,99,235,0.3);
}
.key.pressed .sub { color: rgba(255,255,255,0.6); }

.key.special { color: var(--special); }
.key.special:hover { background: var(--special-light); border-color: #c4b5fd; }
.key.special.pressed {
  background: var(--special);
  border-color: #6d28d9;
  color: #fff;
  box-shadow: 0 2px 8px rgba(124,58,237,0.3);
}

/* ── Charts col (right of keypad) ── */
.charts-col {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* ── Sequence player — FULL WIDTH ── */
.seq-card {
  width: 100%;
}

.seq-row {
  display: flex;
  gap: 8px;
  align-items: center;
}

.seq-input {
  flex: 1;
  font-family: 'DM Mono', monospace;
  font-size: 1rem;
  padding: 11px 16px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
  letter-spacing: 0.12em;
  min-width: 0;
}
.seq-input:focus { border-color: var(--accent); background: #fff; }
.seq-input::placeholder { color: var(--muted); letter-spacing: 0; }

.btn {
  padding: 11px 20px;
  border-radius: 8px;
  border: none;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.15s, transform 0.1s;
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
  flex-shrink: 0;
}
.btn:hover { opacity: 0.85; }
.btn:active { transform: scale(0.96); }

.btn-primary { background: var(--accent); color: #fff; }
.btn-ghost {
  background: var(--bg);
  color: var(--muted);
  border: 1.5px solid var(--border);
}
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

.seq-hint {
  font-size: 0.8rem;
  color: var(--muted);
  margin-top: 9px;
}

/* Progress bar for sequence */
.seq-progress {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin-top: 12px;
  overflow: hidden;
  display: none;
}
.seq-progress.visible { display: block; }
.seq-progress-bar {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  width: 0%;
  transition: width 0.1s linear;
}

/* ── Charts ── */
.chart-label {
  font-size: 0.78rem;
  font-weight: 500;
  color: var(--muted);
}

.chart-label strong {
  color: var(--text);
  font-weight: 600;
}

canvas {
  display: block;
  width: 100% !important;
  border-radius: 0 0 var(--radius) var(--radius);
}
#waveCanvas { height: 150px; }
#specCanvas { height: 150px; }

/* Legend */
.legend {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  padding: 0 18px 12px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 0.72rem;
  color: var(--muted);
}
.legend-dot {
  width: 20px;
  height: 2.5px;
  border-radius: 2px;
  flex-shrink: 0;
}

/* Idle state */
.chart-idle {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  color: var(--muted);
  pointer-events: none;
}

.chart-wrap { position: relative; }

@media (max-width: 700px) {
  .top-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<header>
  <h1>DTMF Sinyal Sentezi</h1>
</header>

<div class="layout">

  <!-- TOP ROW: Tuş Takımı (sol) + Grafikler (sağ) -->
  <div class="top-row">

    <!-- Left: Keypad -->
    <div class="card">
      <div class="card-header">
        Tuş Takımı
        <span id="statusBadge" style="font-size:0.7rem;padding:3px 10px;border-radius:20px;background:var(--bg);color:var(--muted);border:1px solid var(--border);font-weight:500;">BEKLEMEDE</span>
      </div>
      <div class="card-body">
        <div class="info-strip">
          <div class="info-item">
            <span class="lbl">Tuş</span>
            <span class="val" id="dispKey">—</span>
          </div>
          <div class="info-item">
            <span class="lbl">Durum</span>
            <span class="val" id="dispStatus">—</span>
          </div>
          <div class="info-item">
            <span class="lbl">f_low</span>
            <span class="val" id="dispLow">— Hz</span>
          </div>
          <div class="info-item">
            <span class="lbl">f_high</span>
            <span class="val" id="dispHigh">— Hz</span>
          </div>
        </div>
        <div class="keypad-grid" id="keypad"></div>
      </div>
    </div>

    <!-- Right: Charts -->
    <div class="charts-col">

      <div class="card">
        <div class="card-header">
          <span>Zaman Uzayı — Sinüzoidal Dalga</span>
          <span class="chart-label" id="waveInfo">—</span>
        </div>
        <div class="chart-wrap">
          <canvas id="waveCanvas"></canvas>
          <div class="chart-idle" id="waveIdle">Bir tuşa basın</div>
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--wave-low)"></div>
            f_low bileşeni
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--wave-high)"></div>
            f_high bileşeni
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--wave-sum)"></div>
            DTMF toplamı x(t)
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span>Frekans Uzayı — FFT Spektrum</span>
          <span class="chart-label" id="specInfo">—</span>
        </div>
        <div class="chart-wrap">
          <canvas id="specCanvas"></canvas>
          <div class="chart-idle" id="specIdle">Bir tuşa basın</div>
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--spec-peak)"></div>
            DTMF bileşenleri
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- BOTTOM: Sekans Çal — TAM GENİŞLİK -->
  <div class="card seq-card">
    <div class="card-header">Sekans Çal</div>
    <div class="card-body">
      <div class="seq-row">
        <input class="seq-input" id="seqInput" type="text" maxlength="60"
          placeholder="0-9 A B C D * #"
          value="123456789*0#">
        <button class="btn btn-primary" id="seqPlayBtn" onclick="playSequence()">▶ Çal</button>
        <button class="btn btn-ghost" onclick="stopSequence()" id="seqStopBtn" disabled>■ Durdur</button>
      </div>
      <div class="seq-hint">Her karakter arasına boşluk bırakır. Örn: 112</div>
      <div class="seq-progress" id="seqProgress">
        <div class="seq-progress-bar" id="seqProgressBar"></div>
      </div>
    </div>
  </div>

</div>

<script>
// ── DTMF Table ────────────────────────────────────────────────────────────────
const DTMF = {
  '1':[697,1209],'2':[697,1336],'3':[697,1477],'A':[697,1633],
  '4':[770,1209],'5':[770,1336],'6':[770,1477],'B':[770,1633],
  '7':[852,1209],'8':[852,1336],'9':[852,1477],'C':[852,1633],
  '*':[941,1209],'0':[941,1336],'#':[941,1477],'D':[941,1633],
};
const LAYOUT = ['1','2','3','A','4','5','6','B','7','8','9','C','*','0','#','D'];
const SPECIAL = new Set(['A','B','C','D','*','#']);

// ── Build keypad ──────────────────────────────────────────────────────────────
const keypad = document.getElementById('keypad');
LAYOUT.forEach(k => {
  const btn = document.createElement('div');
  btn.className = 'key' + (SPECIAL.has(k) ? ' special' : '');
  btn.dataset.key = k;
  const [fl,fh] = DTMF[k];
  btn.innerHTML = `${k}<span class="sub">${fl}+${fh}</span>`;
  keypad.appendChild(btn);
});

// ── Audio ─────────────────────────────────────────────────────────────────────
const FS = 44100;
const FFT_SIZE = 2048;
const MIN_MS = 150;

let actx = null, gainNode = null;
let osc1 = null, osc2 = null;
let currentKey = null, isHolding = false, toneStart = 0;

function ensureAudio() {
  if (!actx) {
    actx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: FS });
    gainNode = actx.createGain();
    gainNode.gain.value = 0.001;
    gainNode.connect(actx.destination);
  }
  if (actx.state === 'suspended') actx.resume();
}

function killOscs() {
  [osc1, osc2].forEach(o => { if (o) { try { o.stop(); o.disconnect(); } catch(e){} } });
  osc1 = osc2 = null;
}

function playTone(fl, fh) {
  ensureAudio();
  killOscs();
  gainNode.gain.cancelScheduledValues(actx.currentTime);
  gainNode.gain.setValueAtTime(0.001, actx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.4, actx.currentTime + 0.012);

  osc1 = actx.createOscillator(); osc1.type = 'sine';
  osc2 = actx.createOscillator(); osc2.type = 'sine';
  osc1.frequency.value = fl;
  osc2.frequency.value = fh;
  osc1.connect(gainNode); osc2.connect(gainNode);
  osc1.start(); osc2.start();
}

function fadeStop() {
  if (!actx || !gainNode) return;
  const t = actx.currentTime;
  gainNode.gain.cancelScheduledValues(t);
  gainNode.gain.setValueAtTime(gainNode.gain.value, t);
  gainNode.gain.exponentialRampToValueAtTime(0.001, t + 0.04);
  const o1 = osc1, o2 = osc2; osc1 = osc2 = null;
  setTimeout(() => { if(o1){try{o1.stop();o1.disconnect();}catch(e){}} if(o2){try{o2.stop();o2.disconnect();}catch(e){}} }, 60);
}

// ── Key press logic ───────────────────────────────────────────────────────────
function startKey(k) {
  if (isHolding && currentKey === k) return;
  isHolding = true;
  currentKey = k;
  toneStart = Date.now();
  const [fl, fh] = DTMF[k];
  playTone(fl, fh);
  updateUI(k, fl, fh, true);
  drawCharts(fl, fh);
}

function releaseKey() {
  if (!isHolding) return;
  isHolding = false;
  const k = currentKey;
  const elapsed = Date.now() - toneStart;
  const wait = Math.max(0, MIN_MS - elapsed);
  setTimeout(() => {
    if (!isHolding) {
      fadeStop();
      setStatusBadge('BEKLEME');
      document.getElementById('dispStatus').textContent = '—';
      document.querySelectorAll('.key').forEach(b => b.classList.remove('pressed'));
    }
  }, wait);
}

function updateUI(k, fl, fh, playing) {
  document.querySelectorAll('.key').forEach(b => b.classList.remove('pressed'));
  document.querySelector(`[data-key="${k}"]`).classList.add('pressed');
  document.getElementById('dispKey').textContent = k;
  document.getElementById('dispLow').textContent = fl + ' Hz';
  document.getElementById('dispHigh').textContent = fh + ' Hz';
  document.getElementById('dispStatus').textContent = playing ? 'ÇALIYOR' : '—';
  document.getElementById('waveInfo').innerHTML = `<strong>${k}</strong> &nbsp;x(t) = sin(2π·${fl}·t) + sin(2π·${fh}·t)`;
  document.getElementById('specInfo').innerHTML = `<strong>f₁=${fl} Hz</strong> &nbsp; <strong>f₂=${fh} Hz</strong>`;
  setStatusBadge(playing ? 'ÇALIYOR' : 'BEKLEME');
  document.getElementById('waveIdle').style.display = 'none';
  document.getElementById('specIdle').style.display = 'none';
}

function setStatusBadge(txt) {
  const b = document.getElementById('statusBadge');
  b.textContent = txt;
  b.style.background = txt === 'ÇALIYOR' ? '#eff4ff' : 'var(--bg)';
  b.style.color = txt === 'ÇALIYOR' ? 'var(--accent)' : 'var(--muted)';
  b.style.borderColor = txt === 'ÇALIYOR' ? '#bfd0f7' : 'var(--border)';
}

// ── Event delegation ──────────────────────────────────────────────────────────
keypad.addEventListener('mousedown', e => {
  e.preventDefault();
  const btn = e.target.closest('.key');
  if (btn) startKey(btn.dataset.key);
});
keypad.addEventListener('touchstart', e => {
  e.preventDefault();
  const btn = e.target.closest('.key');
  if (btn) startKey(btn.dataset.key);
}, { passive: false });

document.addEventListener('mouseup', releaseKey);
document.addEventListener('touchend', releaseKey);
document.addEventListener('touchcancel', releaseKey);

document.addEventListener('keydown', e => {
  if (e.repeat || e.target === document.getElementById('seqInput')) return;
  const k = e.key === '*' ? '*' : e.key === '#' ? '#' : e.key.toUpperCase();
  if (DTMF[k]) { e.preventDefault(); startKey(k); }
});
document.addEventListener('keyup', e => {
  if (e.target === document.getElementById('seqInput')) return;
  releaseKey();
});

// ── Sequence player ───────────────────────────────────────────────────────────
let seqRunning = false;
let seqCancel = false;

async function playSequence() {
  if (seqRunning) return;
  const raw = document.getElementById('seqInput').value.toUpperCase().replace(/[^0-9A-D*#]/g, '');
  if (!raw) return;

  ensureAudio();
  seqRunning = true;
  seqCancel = false;
  document.getElementById('seqPlayBtn').disabled = true;
  document.getElementById('seqStopBtn').disabled = false;
  document.getElementById('seqProgress').classList.add('visible');

  const TONE_MS = 200, GAP_MS = 80;

  for (let i = 0; i < raw.length; i++) {
    if (seqCancel) break;
    const k = raw[i];
    const [fl, fh] = DTMF[k];

    playTone(fl, fh);
    updateUI(k, fl, fh, true);
    drawCharts(fl, fh);

    document.getElementById('seqProgressBar').style.width = ((i / raw.length) * 100) + '%';

    await sleep(TONE_MS);
    fadeStop();
    setStatusBadge('BEKLEME');
    document.querySelectorAll('.key').forEach(b => b.classList.remove('pressed'));

    if (i < raw.length - 1) await sleep(GAP_MS);
  }

  document.getElementById('seqProgressBar').style.width = '100%';
  setTimeout(() => {
    document.getElementById('seqProgress').classList.remove('visible');
    document.getElementById('seqProgressBar').style.width = '0%';
  }, 400);

  seqRunning = false;
  document.getElementById('seqPlayBtn').disabled = false;
  document.getElementById('seqStopBtn').disabled = true;
}

function stopSequence() {
  seqCancel = true;
  fadeStop();
  seqRunning = false;
  document.getElementById('seqPlayBtn').disabled = false;
  document.getElementById('seqStopBtn').disabled = true;
  document.getElementById('seqProgress').classList.remove('visible');
  setStatusBadge('BEKLEME');
  document.querySelectorAll('.key').forEach(b => b.classList.remove('pressed'));
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ── Charts ────────────────────────────────────────────────────────────────────
const waveCanvas = document.getElementById('waveCanvas');
const specCanvas = document.getElementById('specCanvas');
const wCtx = waveCanvas.getContext('2d');
const sCtx = specCanvas.getContext('2d');

function resizeCanvas(c) {
  const dpr = devicePixelRatio || 1;
  const rect = c.getBoundingClientRect();
  c.width = rect.width * dpr;
  c.height = rect.height * dpr;
}

function drawCharts(fl, fh) {
  resizeCanvas(waveCanvas);
  resizeCanvas(specCanvas);
  drawWave(fl, fh);
  drawSpectrum(fl, fh);
}

function drawWave(fl, fh) {
  const ctx = wCtx;
  const W = waveCanvas.width, H = waveCanvas.height;
  const dpr = devicePixelRatio || 1;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, W, H);

  ctx.strokeStyle = '#f0f2f5';
  ctx.lineWidth = 1;
  for (let i = 1; i < 4; i++) {
    const y = (H / 4) * i;
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  ctx.strokeStyle = '#d1d8e0';
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(0, H / 2); ctx.lineTo(W, H / 2); ctx.stroke();

  const tickFont = `${10 * dpr}px DM Mono, monospace`;
  ctx.font = tickFont;
  ctx.fillStyle = '#aab0ba';
  ctx.textAlign = 'right';
  ctx.fillText('+1', W - 6 * dpr, 10 * dpr);
  ctx.fillText('0', W - 6 * dpr, H / 2 + 4 * dpr);
  ctx.fillText('-1', W - 6 * dpr, H - 4 * dpr);
  ctx.textAlign = 'left';

  const T = 3 / fl;
  const N = W;

  ctx.beginPath();
  ctx.strokeStyle = '#93b4f4';
  ctx.lineWidth = 1.5 * dpr;
  for (let i = 0; i < N; i++) {
    const t = (i / N) * T;
    const y = H / 2 - (H * 0.3) * Math.sin(2 * Math.PI * fl * t);
    i === 0 ? ctx.moveTo(i, y) : ctx.lineTo(i, y);
  }
  ctx.stroke();

  ctx.beginPath();
  ctx.strokeStyle = '#f4a090';
  ctx.lineWidth = 1.5 * dpr;
  for (let i = 0; i < N; i++) {
    const t = (i / N) * T;
    const y = H / 2 - (H * 0.3) * Math.sin(2 * Math.PI * fh * t);
    i === 0 ? ctx.moveTo(i, y) : ctx.lineTo(i, y);
  }
  ctx.stroke();

  ctx.beginPath();
  ctx.strokeStyle = '#2563eb';
  ctx.lineWidth = 2.5 * dpr;
  for (let i = 0; i < N; i++) {
    const t = (i / N) * T;
    const s = 0.5 * (Math.sin(2 * Math.PI * fl * t) + Math.sin(2 * Math.PI * fh * t));
    const y = H / 2 - (H * 0.38) * s;
    i === 0 ? ctx.moveTo(i, y) : ctx.lineTo(i, y);
  }
  ctx.stroke();

  ctx.font = `${9.5 * dpr}px DM Mono, monospace`;
  ctx.fillStyle = '#aab0ba';
  ctx.textAlign = 'left';
  ctx.fillText(`0`, 6 * dpr, H - 5 * dpr);
  ctx.fillText(`${(T * 1000).toFixed(1)} ms`, W * 0.5, H - 5 * dpr);
}

function computeFFT(fl, fh) {
  const N = FFT_SIZE;
  const re = new Float32Array(N);
  const im = new Float32Array(N);
  for (let i = 0; i < N; i++) {
    const t = i / FS;
    const w = 0.5 * (1 - Math.cos(2 * Math.PI * i / N));
    re[i] = w * 0.5 * (Math.sin(2 * Math.PI * fl * t) + Math.sin(2 * Math.PI * fh * t));
  }
  fftInPlace(re, im);
  const mag = new Float32Array(N / 2);
  for (let i = 0; i < N / 2; i++) mag[i] = Math.sqrt(re[i] ** 2 + im[i] ** 2) / N;
  return mag;
}

function fftInPlace(re, im) {
  const n = re.length;
  for (let i = 1, j = 0; i < n; i++) {
    let bit = n >> 1;
    for (; j & bit; bit >>= 1) j ^= bit;
    j ^= bit;
    if (i < j) { [re[i], re[j]] = [re[j], re[i]]; [im[i], im[j]] = [im[j], im[i]]; }
  }
  for (let len = 2; len <= n; len <<= 1) {
    const ang = -2 * Math.PI / len;
    const wr = Math.cos(ang), wi = Math.sin(ang);
    for (let i = 0; i < n; i += len) {
      let cr = 1, ci = 0;
      for (let j = 0; j < len / 2; j++) {
        const ur = re[i+j], ui = im[i+j];
        const vr = re[i+j+len/2]*cr - im[i+j+len/2]*ci;
        const vi = re[i+j+len/2]*ci + im[i+j+len/2]*cr;
        re[i+j] = ur+vr; im[i+j] = ui+vi;
        re[i+j+len/2] = ur-vr; im[i+j+len/2] = ui-vi;
        [cr, ci] = [cr*wr - ci*wi, cr*wi + ci*wr];
      }
    }
  }
}

function drawSpectrum(fl, fh) {
  const ctx = sCtx;
  const W = specCanvas.width, H = specCanvas.height;
  const dpr = devicePixelRatio || 1;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, W, H);

  const mag = computeFFT(fl, fh);
  const maxFreq = 2000;
  const maxBin = Math.floor(maxFreq * FFT_SIZE / FS);

  let maxMag = 0;
  for (let i = 1; i < maxBin; i++) if (mag[i] > maxMag) maxMag = mag[i];
  if (maxMag < 1e-10) maxMag = 1;

  // Grafiğin altından etiketler için daha fazla boşluk bırakıyoruz
  const PLOT_H = H - 30 * dpr; 
  const binPx = W / maxBin;

  // Yatay Izgara Çizgileri
  ctx.strokeStyle = '#f0f2f5';
  ctx.lineWidth = 1;
  for (let db = 0.25; db < 1; db += 0.25) {
    const y = PLOT_H * (1 - db);
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // --- SADECE DTMF BİLEŞENLERİNİ ÇİZ (Gürültü Gizlendi) ---
  for (let i = 1; i < maxBin; i++) {
    const norm = mag[i] / maxMag;
    if (norm < 0.05) continue; // %5'in altındaki hesaplama sızıntılarını yoksay
    
    const barH = norm * PLOT_H;
    const x = (i / maxBin) * W;
    
    ctx.fillStyle = '#2563eb'; // Tüm pikler mavi
    ctx.fillRect(x, PLOT_H - barH, Math.max(binPx - 0.5, 1), barH);
  }

  // X Ekseni (Alt Çizgi)
  ctx.strokeStyle = '#d1d8e0';
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(0, PLOT_H); ctx.lineTo(W, PLOT_H); ctx.stroke();

  // --- X EKSENİ ETİKETLERİ VE TAŞMA KONTROLÜ ---
  ctx.font = `${9.5 * dpr}px DM Mono, monospace`;
  for (let f = 0; f <= maxFreq; f += 200) {
    const x = (f / maxFreq) * W;
    
    // Dikey kılavuz çizgiler
    ctx.strokeStyle = '#e8eaed';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, PLOT_H); ctx.stroke();
    
    ctx.fillStyle = '#8a929e';
    
    // TAŞMA ÇÖZÜMÜ: Başlangıç sola, bitiş sağa, diğerleri ortaya hizalanır
    if (f === 0) {
      ctx.textAlign = 'left';
      ctx.fillText(f, x + 4 * dpr, PLOT_H + 14 * dpr);
    } else if (f === maxFreq) {
      ctx.textAlign = 'right';
      ctx.fillText(f, x - 4 * dpr, PLOT_H + 14 * dpr);
    } else {
      ctx.textAlign = 'center';
      ctx.fillText(f, x, PLOT_H + 14 * dpr);
    }
  }

  // Ana Eksen Başlığı
  ctx.textAlign = 'center';
  ctx.font = `bold ${9 * dpr}px DM Sans, sans-serif`;
  ctx.fillText('FREKANS (Hz)', W / 2, H - 4 * dpr);

  // Tepe Noktası Rozetleri (f1 ve f2 kutucukları)
  [[fl, 'f₁'], [fh, 'f₂']].forEach(([f, lbl]) => {
    const x = (f / maxFreq) * W;
    const norm = Math.max(...Array.from({length: 5}, (_, j) => {
      const b = Math.round((f - 2 + j) * FFT_SIZE / FS);
      return b >= 0 && b < mag.length ? mag[b] / maxMag : 0;
    }));
    const barTop = PLOT_H - norm * PLOT_H;

    ctx.setLineDash([3 * dpr, 3 * dpr]);
    ctx.strokeStyle = '#2563eb';
    ctx.lineWidth = 1.5 * dpr;
    ctx.beginPath(); ctx.moveTo(x, barTop - 6 * dpr); ctx.lineTo(x, 4 * dpr); ctx.stroke();
    ctx.setLineDash([]);

    const txt = `${lbl} ${f} Hz`;
    const tw = ctx.measureText(txt).width;
    const bw = tw + 10 * dpr, bh = 14 * dpr;
    let bx = x - bw / 2;
    bx = Math.max(2, Math.min(W - bw - 2, bx)); // Kutunun kenarlardan taşmasını engeller
    const by = 2 * dpr;
    
    ctx.fillStyle = '#eff4ff';
    ctx.beginPath();
    ctx.roundRect(bx, by, bw, bh, 4 * dpr);
    ctx.fill();
    ctx.strokeStyle = '#bfd0f7';
    ctx.lineWidth = 1;
    ctx.stroke();
    
    ctx.fillStyle = '#2563eb';
    ctx.textAlign = 'center';
    ctx.font = `${9 * dpr}px DM Mono, monospace`;
    ctx.fillText(txt, bx + bw / 2, by + 10 * dpr);
  });
}

window.addEventListener('resize', () => {
  if (currentKey) {
    const [fl, fh] = DTMF[currentKey];
    drawCharts(fl, fh);
  }
});

setTimeout(() => {
  resizeCanvas(waveCanvas);
  resizeCanvas(specCanvas);
}, 50);
</script>
</body>
</html>
